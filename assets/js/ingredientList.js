/**
 * Handles the dynamic addition and removal of RecipeIngredient form rows.
 * This function should be initialized on the DOMContentLoaded event.
 */
document.addEventListener('DOMContentLoaded', () => {

    console.log('initialize ingredients list');

    const list = document.getElementById('ingredient-fields-list');
    const addButton = document.getElementById('add-ingredient-button');

    // Function to add the 'remove' button functionality to a new element
    const addDeleteButtonHandler = (item) => {
        item.querySelector('.remove-ingredient-btn').addEventListener('click', (e) => {
            e.preventDefault();
            item.remove();
        });
    };

    // Initialize delete handlers for existing elements (if any)
    list.querySelectorAll('.ingredient-item').forEach(addDeleteButtonHandler);

    // Function to add a new ingredient row
    const addIngredientForm = () => {
        // Get the prototype (the template for a new field)
        const prototype = list.dataset.prototype;
        let index = parseInt(list.dataset.index || list.children.length);

        // Create a new form row based on the prototype
        let newForm = prototype.replace(/__name__/g, index);
        index++;

        // --- CUSTOM WRAPPER START ---
        // Twig form_row renders label+errors+widget, so we wrap all 3 widgets in a grid container

        // The newForm variable contains the raw HTML input fields.
        // We need to extract the raw form_row output for the three fields.

        // This is a complex fix that usually requires pre-rendered partials,
        // but we can simplify the resulting structure here by using
        // the structure that Symfony generates.

        // For simplicity and stability, the best approach is to recreate the
        // exact grid structure we defined above:

        const wrapper = document.createElement('div');
        wrapper.innerHTML = newForm;

        // Reconstruct the inner structure manually since the JS prototype doesn't include form_row wrappers
        const elements = wrapper.querySelectorAll('input, select');

        if (elements.length >= 3) {
            const rowContainer = document.createElement('div');
            rowContainer.className = 'ingredient-item bg-gray-50 p-4 rounded-lg mb-3 flex items-start space-x-3 border border-gray-200';

            const innerGrid = document.createElement('div');
            innerGrid.className = 'grid grid-cols-5 gap-3 flex-grow space-y-0';

            const createDiv = (el, colSpan) => {
                const div = document.createElement('div');
                div.className = `col-span-${colSpan}`;
                div.appendChild(el);
                return div;
            };

            // The element order in the prototype is quantity, unit, ingredient
            // We need it to be Ingredient (3), Quantity (1), Unit (1)

            // Find all inputs/selects generated by Symfony's prototype
            const quantityInput = wrapper.querySelector('[id$="_quantity"]');
            const unitInput = wrapper.querySelector('[id$="_unit"]');
            const ingredientSelect = wrapper.querySelector('[id$="_ingredient"]');

            // Manually wrap the elements in the correct grid structure
            innerGrid.appendChild(createDiv(ingredientSelect.closest('.form-group') || ingredientSelect, 3));
            innerGrid.appendChild(createDiv(quantityInput.closest('.form-group') || quantityInput, 1));
            innerGrid.appendChild(createDiv(unitInput.closest('.form-group') || unitInput, 1));

            rowContainer.appendChild(innerGrid);

            // Append the remove button HTML
            const deleteButtonHtml = `
                        <button type="button" class="remove-ingredient-btn text-red-500 hover:text-red-700 mt-2 p-1 rounded-full hover:bg-red-100 transition duration-150" aria-label="Remove ingredient">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3"></path></svg>
                        </button>
                    `;
            rowContainer.insertAdjacentHTML('beforeend', deleteButtonHtml);

            // Add event handler and append to the list
            addDeleteButtonHandler(rowContainer);
            list.appendChild(rowContainer);

        } else {
            // Fallback if structure parsing fails, append the raw content
            list.appendChild(wrapper.firstChild);
        }

        list.dataset.index = index;
    };

    // Re-map the click handler to the simplified function
    addButton.addEventListener('click', (e) => {
        e.preventDefault();
        addIngredientForm();
    });

    // Re-initialize delete handlers for existing elements (if any)
    list.querySelectorAll('.ingredient-item').forEach(addDeleteButtonHandler);

    // Re-adjust the index if necessary (though the default index check should handle it)
    list.dataset.index = list.children.length;

    // FIX: This part is crucial for correctly rendering nested form rows in Twig.
    // When using form_row(), Symfony automatically wraps the label, widget, and errors
    // in a div (usually with class `form-group` or similar). The prototype itself doesn't
    // know about these wrappers. We manually adjust the existing ingredient field rendering
    // in the loop to use form_row(field) instead of form_widget(field) to keep consistency.
    // Since the user provided the Twig with form_widget already,
    // we manually adjust the JavaScript portion to manage the lack of Symfony's form row divs
    // or modify the existing Twig logic slightly.

    // Re-checking the existing twig:
    // {% for ingredientField in form.recipeIngredients %}
    //     ...
    //     <div class="flex-grow space-y-2">
    //         {{ form_widget(ingredientField) }}
    //     </div>
    //     ...
    // {% endfor %}
    //
    // It seems the form_widget(ingredientField) renders the inner three widgets without labels/divs,
    // which is why the previous styling relied heavily on PHP classes.

    // To make the static part match the new grid structure for existing fields:
    // We need to modify the Twig loop structure to use form_row() for proper wrapping
    // OR manually adjust classes. Since PHP files are more complete, let's trust the PHP class application
    // and update the TWIG structure to support the grid layout.
});
